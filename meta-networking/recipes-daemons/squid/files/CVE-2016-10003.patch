author: Eduard Bagdasaryan <eduard.bagdasaryan@measurement-factory.com>
committer: Amos Jeffries <squid3@treenet.co.nz>
branch nick: trunk
timestamp: Fri 2016-12-16 15:43:39 +1300
message:

  Do not share private responses with collapsed client(s).

Upstream-status: Backport
Signed-off-by: Thiruvadi Rajaraman <trajaraman@mvista.com>

Index: squid-3.5.20/src/client_side_reply.cc
===================================================================
--- squid-3.5.20.orig/src/client_side_reply.cc	2016-07-01 17:07:50.000000000 +0530
+++ squid-3.5.20/src/client_side_reply.cc	2017-05-31 13:15:46.541291519 +0530
@@ -473,6 +482,17 @@
         return;
     }
 
+ 
+    // The previously identified hit suddenly became unsharable!
+    // This is common for collapsed forwarding slaves but might also
+    // happen to regular hits because we are called asynchronously.
+    if (EBIT_TEST(e->flags, KEY_PRIVATE)) {
+        debugs(88, 3, "unsharable " << *e << ". MISS");
+        http->logType = LOG_TCP_MISS;
+        processMiss();
+        return;
+    }
+
     if (result.length == 0) {
         debugs(88, 5, "store IO buffer has no content. MISS");
         /* the store couldn't get enough data from the file for us to id the
