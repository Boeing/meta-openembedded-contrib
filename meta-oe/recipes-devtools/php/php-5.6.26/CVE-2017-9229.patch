commit b690371bbf97794b4a1d3f295d4fb9a8b05d402d
Author: K.Kosako <kosako@sofnec.co.jp>
Date:   Wed May 24 10:27:04 2017 +0900

    fix #59 : access to invalid address by reg->dmax value

Upstream-Status: Backport

CVE: CVE-2017-9229
Signed-off-by: Thiruvadi Rajaraman <trajaraman@mvista.com>


Index: php-5.6.26/ext/mbstring/oniguruma/regexec.c
===================================================================
--- php-5.6.26.orig/ext/mbstring/oniguruma/regexec.c	2017-09-19 19:45:51.001205292 +0530
+++ php-5.6.26/ext/mbstring/oniguruma/regexec.c	2017-09-19 19:51:46.193527423 +0530
@@ -3209,6 +3209,12 @@
     }
     else {
       if (reg->dmax != ONIG_INFINITE_DISTANCE) {
+        if (p - str < reg->dmax) {
+          *low = (UChar* )str;
+          if (low_prev)
+            *low_prev = onigenc_get_prev_char_head(reg->enc, str, *low);
+	}
+	else {
 	*low = p - reg->dmax;
 	if (*low > s) {
 	  *low = onigenc_get_right_adjust_char_head_with_prev(reg->enc, s,
@@ -3223,6 +3229,7 @@
 					       (pprev ? pprev : str), *low);
 	}
       }
+     }
     }
     /* no needs to adjust *high, *high is used as range check only */
     *high = p - reg->dmin;
